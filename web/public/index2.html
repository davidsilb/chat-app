<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat AI Compiler</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
  <style>
    #responses.grid-layout {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 10px;
    }
    #responses.list-layout {
      display: flex;
      flex-direction: column;
    }
    .response {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 12px;
    }
    .services-list {
      max-height: 200px;
      overflow-y: scroll;
      border: 1px solid #ddd;
      padding: 10px;
    }
    .services-list label {
      display: block;
    }
    .scrollable-table {
    max-height: 100px; /* Set the desired height for the scrollable area */
    overflow-y: auto; /* Enable vertical scrolling */
    border: 1px solid #ddd; /* Optional: Add a border around the scrollable area */
    }
      #leaderboardPanel {
      position: fixed;
      top: 80px;
      right: -260px;
      width: 260px;
      height: 300px;
      background-color: #f9f9f9;
      border-left: 2px solid #ccc;
      box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
      transition: right 0.3s ease;
      z-index: 1000;
      padding: 10px;
    }

    #leaderboardPanel.open {
      right: 0;
    }

    #toggleArrow {
    position: fixed;
    top: 90px;
    right: 0;
    width: 120px;
    height: 40px;
    background-color: #007bff;
    color: white;
    font-size: 14px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 10px;
    cursor: pointer;
    z-index: 1001;
    border-top-left-radius: 5px;
    border-bottom-left-radius: 5px;
    box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
    transition: background-color 0.3s ease;
    }
    #toggleArrow:hover {
      background-color: #0056b3;
    }
    #toggleText {
      flex-grow: 1;
    }
    #toggleIcon {
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="my-4">Chat AI Compiler</h1>
    <p id="username"></p>
    <div id="auth-buttons" style="margin-bottom: 20px;"></div>
    <p>Select AI services, type a question, and get responses.</p>
    <!-- Toggle Button -->
    <div id="toggleArrow">
      <span id="toggleText">Leaderboard</span>
      <span id="toggleIcon">&#9664;</span>
    </div>

    <!-- Slide-Out Leaderboard Panel -->
    <div id="leaderboardPanel">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>AI Leaderboard</th>
            <th>Running Score</th>
          </tr>
        </thead>
        <tbody id="table-body">
        </tbody>
      </table>
    </div>
    <form id="chatForm" class="mb-4">
      <div class="form-group">
        <label>Select AI Services:</label>
        <div class="mb-2">
          <button id="selectAll" type="button" class="btn btn-sm btn-outline-primary">Select All</button>
          <button id="deselectAll" type="button" class="btn btn-sm btn-outline-secondary">Deselect All</button>
        </div>
        <div class="services-list">
          <label><input type="checkbox" name="aiServices" value="compound-beta-mini"> compound-beta-mini</label>
          <label><input type="checkbox" name="aiServices" value="meta-llama/llama-4-maverick-17b-128e-instruct"> meta-llama/llama-4-maverick-17b-128e-instruct</label>
          <label><input type="checkbox" name="aiServices" value="qwen-qwq-32b"> qwen-qwq-32b</label>
          <label><input type="checkbox" name="aiServices" value="llama3-8b-8192"> llama3-8b-8192</label>
          <label><input type="checkbox" name="aiServices" value="gemma2-9b-it"> gemma2-9b-it</label>
          <label><input type="checkbox" name="aiServices" value="deepseek-r1-distill-llama-70b"> deepseek-r1-distill-llama-70b</label>
          <label><input type="checkbox" name="aiServices" value="llama3-70b-8192"> llama3-70b-8192</label>
          <label><input type="checkbox" name="aiServices" value="mistral-saba-24b"> mistral-saba-24b</label>
          <label><input type="checkbox" name="aiServices" value="compound-beta"> compound-beta</label>
          <label><input type="checkbox" name="aiServices" value="llama-3.1-8b-instant"> llama-3.1-8b-instant</label>
          <label><input type="checkbox" name="aiServices" value="llama-3.3-70b-versatile"> llama-3.3-70b-versatile</label>
          <label><input type="checkbox" name="aiServices" value="meta-llama/llama-4-scout-17b-16e-instruct"> meta-llama/llama-4-scout-17b-16e-instruct</label>
        </div>
      </div>
      <div class="form-group">
        <label for="msg">Enter your message:</label>
        <input type="text" id="msg" class="form-control" placeholder="Say something..." />
      </div>
      <button type="submit" class="btn btn-primary">Send</button>
    </form>

    <div id="responseContainer">
      <div id="toolbar" class="mb-2">
        <button id="gridView" class="btn btn-secondary">Grid View</button>
        <button id="listView" class="btn btn-secondary">List View</button>
        <button id="exportCSV" class="btn btn-secondary">Export to CSV</button>
        <button id="exportTXT" class="btn btn-secondary">Export to TXT</button>
        <button id="copyToClipboard" class="btn btn-secondary">Copy to Clipboard</button>
      </div>
      <div id="responses" class="grid-layout"></div>
    </div>
  </div>

 <script>
let currentData = { message: '', responses: [] };
  window.onload = function () {
    document.getElementById("copyToClipboard").onclick = () => {
      if (!currentData.message || !currentData.responses.length) {
        return alert("No data to copy.");
      }

      let txt = "";

      currentData.responses.forEach(({ service, response, timestamp }, index) => {
        txt += `Entry #${index + 1}\n`;
        txt += `Message:   ${currentData.message}\n`;
        txt += `Service:   ${service}\n`;
        txt += `Timestamp: ${timestamp}\n`;
        txt += `Response:\n${response.replace(/\r?\n/g, '\n')}\n`;
        txt += `\n----------------------------------------\n\n`;
      });

      navigator.clipboard.writeText(txt)
        .then(() => alert("Copied to clipboard!"))
        .catch(() => alert("Failed to copy to clipboard."));
    };
  };
</script>
  <script>
    document.getElementById("table-body").innerHTML = "";
    const AI_data = [
      { name: "compound-beta-mini", rating: 0 },
      { name: "meta-llama/llama-4-maverick-17b-128e-instruct", rating: 0 },
      { name: "qwen-qwq-32b", rating: 0 },
      { name: "llama3-8b-8192", rating: 0 },
      { name: "gemma2-9b-it", rating: 0 },
      { name: "deepseek-r1-distill-llama-70b", rating: 0 },
      { name: "llama3-70b-8192", rating: 0 },
      { name: "mistral-saba-24b", rating: 0 },
      { name: "compound-beta", rating: 0 },
      { name: "llama-3.1-8b-instant", rating: 0 },
      { name: "llama-3.3-70b-versatile", rating: 0 },
      { name: "meta-llama/llama-4-scout-17b-16e-instruct", rating: 0 }
    ];
    
  document.addEventListener("DOMContentLoaded", () => {
    // Reference the table body
    const table_Body = document.getElementById("table-body");
    table_Body.innerHTML = '';

    // Generate table rows dynamically
    AI_data.forEach(item => {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${item.name}</td><td>${item.rating}</td>`;
      table_Body.appendChild(row);
    });
  });

    document.getElementById("chatForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const message = document.getElementById("msg").value.trim();
      const selected = Array.from(document.querySelectorAll("input[name='aiServices']:checked"))
                            .map(cb => cb.value);

      if (!message) return alert("Please enter a message.");
      if (selected.length === 0) return alert("Please select at least one AI service.");

      const responsesDiv = document.getElementById("responses");
      responsesDiv.innerHTML = "";
      currentData = { message, responses: [] };

      try {
        const res = await fetch("/api/batch-chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
            message,
            role: "user", // or allow choosing "system", "user", etc later
            models: selected
            })
        });

        const data = await res.json();

        if (!data.success || !data.chats) {
            throw new Error(data.error || "Unknown error");
        }

        // Populate responses
        data.chats.forEach(chat => {
            const { responses } = chat;
            responses.forEach(({ model, content }) => {
            currentData.responses.push({
                service: model,
                response: content,
                timestamp: new Date().toISOString()
            });

            const div = document.createElement("div");
            div.className = "response";
            div.innerHTML = `<h5>${model}<button class="btn btn-primary ms-3" onclick="increment('${model}')">Rate Me</button></h5><p>${content}</p>`;
            document.getElementById("responses").appendChild(div);
            });
        });

        } catch (err) {
        console.error("Batch chat error:", err);
        alert("Error sending batch chat: " + err.message);
        }
    });

    document.getElementById("gridView").onclick = () => {
      const r = document.getElementById("responses");
      r.classList.replace("list-layout", "grid-layout");
    };
    document.getElementById("listView").onclick = () => {
      const r = document.getElementById("responses");
      r.classList.replace("grid-layout", "list-layout");
    };
    document.getElementById("exportCSV").onclick = () => {
      if (!currentData.message || !currentData.responses.length) {
        return alert("No data to export.");
      }
      let csv = "Message,Service,Response,Timestamp\n";
      currentData.responses.forEach(({service,response,timestamp}) => {
        csv += [`"${currentData.message}"`,`"${service}"`,`"${response.replace(/"/g,'""')}"`,`"${timestamp}"`].join(",") + "\n";
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "responses.csv";
      link.click();
    };
  function increment(svc) {
  // Find the AI_data entry for the given svc
    const aiEntry = AI_data.find(item => item.name === svc);
    if (aiEntry) {
      aiEntry.rating += 1; // Increment the rating
      console.log(`${svc} rating incremented to ${aiEntry.rating}`);
      // Update the leaderboard dynamically
    const tableRow = Array.from(document.querySelectorAll("#table-body tr"))
      .find(row => row.firstChild.textContent === svc);
    if (tableRow) {
      tableRow.lastChild.textContent = aiEntry.rating; // Update the rating cell
    }
    } 
    else {
      console.error(`Service "${svc}" not found in AI_data.`);
    }
  }

   document.getElementById("exportTXT").onclick = () => {
      if (!currentData.message || !currentData.responses.length) {
      return alert("No data to export.");
  }

  let txt = "";

  currentData.responses.forEach(({ service, response, timestamp }, index) => {
    txt += `Entry #${index + 1}\n`;
    txt += `Message:   ${currentData.message}\n`;
    txt += `Service:   ${service}\n`;
    txt += `Timestamp: ${timestamp}\n`;
    txt += `Response:\n${response.replace(/\r?\n/g, '\n')}\n`; // preserve line breaks
    txt += `\n----------------------------------------\n\n`; // separator between entries
  });

  const blob = new Blob([txt], { type: "text/plain" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "responses.txt";
  link.click();
};

    const serviceCheckboxes = () =>
      document.querySelectorAll("input[name='aiServices']");

    document.getElementById("selectAll").addEventListener("click", () => {
      serviceCheckboxes().forEach(cb => cb.checked = true);
    });
    document.getElementById("deselectAll").addEventListener("click", () => {
      serviceCheckboxes().forEach(cb => cb.checked = false);
    });
    
  </script>
  <script>
    const panel = document.getElementById('leaderboardPanel');
    const toggle = document.getElementById('toggleArrow');
  
    toggle.addEventListener('click', () => {
    panel.classList.toggle('open');
    const icon = document.getElementById('toggleIcon');
    icon.innerHTML = panel.classList.contains('open') ? '&#9654;' : '&#9664;';
    });
  </script>
<script>
  fetch('/api/whoaminame')
    .then(res => res.json())
    .then(data => {
      const usernameElement = document.getElementById('username');
      const authButtons = document.getElementById('auth-buttons');
      authButtons.innerHTML = ''; // clear old buttons
      
      if (data.loggedIn) {
        usernameElement.innerText = 'Logged in as: ' + (data.username || 'Guest');
        
        // Create History Button
        const historyBtn = document.createElement('button');
        historyBtn.className = 'btn btn-success mr-2';
        historyBtn.innerText = 'View History';
        historyBtn.onclick = () => {
          window.location.href = '/dashboard.html';
        };

        // Create Logout Button
        const logoutBtn = document.createElement('button');
        logoutBtn.className = 'btn btn-danger';
        logoutBtn.innerText = 'Logout';
        logoutBtn.onclick = () => {
          // Logout and refresh
          fetch('/logout', { method: 'POST' })
            .then(() => window.location.reload())
            .catch(err => console.error('Logout error', err));
        };

        authButtons.appendChild(historyBtn);
        authButtons.appendChild(logoutBtn);

      } else {
        usernameElement.innerText = 'Not logged in';
        
        // Create Login Button
        const loginBtn = document.createElement('button');
        loginBtn.className = 'btn btn-primary';
        loginBtn.innerText = 'Login';
        loginBtn.onclick = () => {
          window.location.href = '/login.html';
        };

        authButtons.appendChild(loginBtn);
      }
    })
    .catch(err => {
      console.error('Failed to fetch user info:', err);
      document.getElementById('username').innerText = 'Error loading user';
    });
</script> 
</body>
</html>
